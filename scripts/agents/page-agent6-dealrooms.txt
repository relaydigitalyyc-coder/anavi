=== TASK: Upgrade client/src/pages/DealRooms.tsx for ANAVI whitepaper vision conformance ===
Module: DEAL ROOMS -- Embedded Deal Infrastructure


=== ANAVI WHITEPAPER CONTEXT ===

ANAVI is "The Private Market Operating System" ("If Bloomberg runs public markets, ANAVI will run private ones").

Six core modules:
1. TRUST & IDENTITY — Trust Score (0-100), composite of KYB depth, transaction history,
   dispute outcomes, peer attestations. Three tiers: Basic / Enhanced / Institutional.
   Compliance Passport travels with every transaction.
2. RELATIONSHIP CUSTODY — Timestamped, cryptographically signed introductions.
   "Custodied" = protected with hash proof. "Open" = visible but unprotected.
3. BLIND MATCHING — Intents expressed anonymously. Counterparty identity sealed until
   mutual consent. Match cards: "Sealed -- [AssetClass]", compatibility score, deal size.
   "Blind Intent" = anonymous intent. "Blind Match" = sealed result brief.
4. DEAL ROOMS — NDA-gated workspaces. Immutable audit trail. Workflow:
   NDA Pending -> Active -> Diligence -> Closing -> Completed.
5. COMPLIANCE / ESCROW — KYB verified, OFAC clean, AML passed. Escrow milestones trigger automatically.
6. ECONOMICS ENGINE — Lifetime attribution. Originators earn 40-60% of fees. Follow-on deals
   compound. Attribution Chain. Payout types: originator_fee, introducer_fee, advisor_fee,
   milestone_bonus, success_fee.

Visual language:
- Navy: #0A1628 (darkest), #1E3A5F (body text/secondary)
- Gold: #C4972A (accent, CTAs)
- Trust green: #059669
- Cards: className="card-elevated p-6"
- Stat chips: "rounded-full bg-[COLOR]/15 px-3 py-1 text-xs font-semibold text-[COLOR]"
- Animations: FadeInView, StaggerContainer, StaggerItem (from @/components/PageTransition)
- Numbers: font-data-hud class; hashes/IDs: font-data-mono class
- Primary CTA: className="btn-gold ..."

=== COPY TOKENS (client/src/lib/copy.ts) ===
// client/src/lib/copy.ts
// Single source of truth for all whitepaper-aligned platform language.
// Import from here — never write custody/attribution/trust copy inline.

export const PLATFORM = {
  tagline: "The Private Market Operating System",
  thesis: "If Bloomberg runs public markets, ANAVI will run private ones.",
  market: "$13 trillion private market",
} as const;

export const PROBLEMS = {
  brokerChain: {
    stat: "5–15",
    headline: "Intermediaries Per Deal",
    body: "5 to 15 intermediaries per deal. Each extracting 1–5%. The originator — the person whose relationship made the deal possible — receives no attribution, no compounding value, and no protection if they're cut out.",
  },
  fraud: {
    stat: "$40B",
    headline: "Annual Fraud Losses",
    body: "$10 to $40 billion in annual US investment fraud losses. Because identity verification across private markets is fragmented, unshared, and trivially forged. Everyone runs their own checks. No one shares the results.",
  },
  dueDiligence: {
    stat: "$500K",
    headline: "Duplicated Per Deal",
    body: "$50,000 to $500,000 per deal in duplicated compliance costs. Every investor in the chain runs the same KYC, the same OFAC screen, the same accreditation check — independently, expensively, and without coordination.",
  },
} as const;

export const PERSONAS = {
  originator: {
    label: "Deal Originator / Broker",
    role: "Relationship Holder",
    problem: "My introductions close deals I never get credit for.",
    answer: "Custody your relationships. Timestamp your introductions. Collect your attribution.",
    tourPitch: "You made 847 introductions last year. ANAVI would have attributed every one.",
  },
  investor: {
    label: "Investor / Family Office",
    role: "Capital Deployer",
    problem: "I can't tell which deals are real or who's already seen them.",
    answer: "Verified counterparties. Blind matching. Mutual consent before any disclosure.",
    tourPitch: "You reviewed 40 deals. ANAVI would have verified every counterparty before you saw the first deck.",
  },
  developer: {
    label: "Developer / Asset Owner",
    role: "Capital Seeker",
    problem: "Raising capital means exposing my thesis before anyone commits.",
    answer: "Anonymous until you consent. NDA-gated rooms. Escrow-backed milestones.",
    tourPitch: "You raised $30M. ANAVI would have protected your thesis until the moment you chose to disclose it.",
  },
} as const;

export type PersonaKey = keyof typeof PERSONAS;

export const TOUR = {
  trustScore: {
    title: "Your Trust Score",
    body: "A dynamic credential built from KYB verification depth, transaction history, dispute resolution outcomes, and peer attestations. It determines your access tier, your whitelist status, and whether counterparties transact with you.",
  },
  relationships: {
    originator: {
      title: "Custody Your Relationship",
      body: "Click to timestamp this introduction with a cryptographic custody hash — immutable proof of when you made it. If this relationship produces a deal in three years, this record is your attribution claim.",
    },
    investor: {
      title: "Protect Your Counterparty",
      body: "Click to custody a counterparty relationship. Every counterparty you protect has passed KYB verification, OFAC screening, and accreditation confirmation — and every disclosure is logged permanently.",
    },
    developer: {
      title: "Seal Your Register",
      body: "Click to seal this relationship. Counterparties know a qualified party exists — nothing is disclosed until mutual consent is established, and every disclosure is cryptographically logged.",
    },
  },
  blindMatch: {
    title: "Blind Match",
    body: "A qualified counterparty has been matched to your intent. Their identity, firm, and terms remain sealed. ANAVI's matching engine operates on anonymized attributes — the platform cannot see unencrypted details until both parties authorize disclosure.",
  },
  dealRoom: {
    title: "Deal Room",
    body: "NDA executed. Immutable audit trail initiated. Every document access, version change, and signature event is cryptographically logged. This record is the basis for originator attribution, payout calculation, and regulatory compliance.",
  },
  attribution: {
    originator: {
      title: "Attribution & Payout",
      body: "Your introduction. $47M Riyadh Solar JV. Originator share: 2.5% — $1.175M — calculated automatically from the closing ledger. Triggered on milestone. No negotiation. No intermediary.",
    },
    investor: {
      title: "Attribution & Payout",
      body: "Your capital deployed across 3 verified SPVs. Every subsequent deal from this relationship credits your participation — compounding attribution over time.",
    },
    developer: {
      title: "Escrow Milestone",
      body: "Milestone reached: $12M of $30M committed. Funds release triggered automatically. Your operator economics, protected and automated.",
    },
  },
  compliance: {
    title: "Compliance Passport",
    body: "This counterparty's compliance passport — KYB verified, OFAC clean, accredited status confirmed — travels with every transaction they execute on ANAVI. You access their verification record. You don't duplicate it. $500,000 in due diligence costs, shared.",
  },
  close: {
    headline: "The Private Market Operating System.",
    subhead: "Every relationship custodied. Every introduction attributed. Every deal closed on infrastructure purpose-built for the $13 trillion private market.",
    cta: {
      title: "Apply for Access",
      body: "You have seen the full picture: relationships protected, matches found, deal rooms secured, payouts automated. What would your relationships be worth if they were protected like this?",
    },
  },
} as const;

export const CUSTODY_RECEIPT = {
  title: "Introduction Custodied.",
  body: "This introduction is now timestamped, cryptographically signed, and permanently attributed to you. If this relationship produces a deal — today or in five years — this record is your claim.",
  cta: "View Your Custody Register",
} as const;

/** Six-module navigation section labels. */
export const MODULES = {
  overview: "OVERVIEW",
  trustIdentity: "TRUST & IDENTITY",
  relationships: "RELATIONSHIPS",
  deals: "DEALS",
  economics: "ECONOMICS",
  intelligence: "INTELLIGENCE",
  settings: "SETTINGS",
} as const;

/** Notification type labels shown on activity feed badges. */
export const NOTIFICATIONS = {
  matchFound:      { label: "MATCH" },
  dealUpdate:      { label: "DEAL ROOM" },
  payoutReceived:  { label: "ATTRIBUTION" },
  complianceAlert: { label: "VERIFICATION" },
  system:          { label: "SYSTEM" },
} as const;

/** Toast messages triggered by dashboard CTA clicks. */
export const TOASTS = {
  navigatingRelationships: "Opening Relationship Custody",
  navigatingDealMatching:  "Opening Blind Matching",
} as const;

/** Dashboard widget titles, labels, and CTAs. */
export const DASHBOARD = {
  trustScore: {
    title: "Trust Score",
    scoreChange: (delta: number) => `${delta > 0 ? "+" : ""}${delta} this month`,
    whitelistStatus: "Whitelist",
    compoundNature:
      "Your score compounds with every verified transaction and peer attestation.",
    breakdownCta: "Click to view breakdown →",
  },
  marketDepth: {
    title: "Market Depth",
    buyersLabel: "Buyers",
    sellersLabel: "Sellers",
  },
  blindMatches: {
    title: "Blind Matches",
    sealedStatus: "Sealed",
    noMatches: "No matches yet. Express an intent to activate matching.",
  },
  dealRooms: {
    title: "Deal Rooms",
    documents: "Documents:",
    auditEvents: "Audit Events:",
    immutableAuditTrail: "Immutable audit trail & document versioning active",
    escrowLabel: "Escrow",
    enterCta: "Enter Deal Room →",
    noDealRooms: "No deal rooms yet. Accept a match to open a deal room.",
  },
  complianceStatus: {
    title: "Compliance Status",
    passportSummary: "Compliance Passport",
    kybStatus: "KYB",
    ofacStatus: "OFAC",
    amlStatus: "AML",
    viewPassportCta: "View Passport",
    badgeRequired: "Required",
    noPendingActions: "All compliance requirements met.",
  },
  payouts: {
    title: "Economics Engine",
    nextPayoutLabel: "Next Payout:",
    lifetimeAttribution: "Lifetime Attribution Value:",
    originationShare: "Originator Share:",
    noPayouts: "No payouts yet. Close a deal to trigger attribution.",
  },
  activeIntents: {
    title: "Your Active Intents",
    manageCta: "Manage Intents",
    noIntents: "No active intents. Visit Blind Matching to express an intent.",
  },
  custodiedRelationships: {
    title: "Relationship Custody",
    custodyAge: "Custodied:",
    attributionCue: "Cryptographic timestamps ensure forever attribution",
    protectCta: "Protect a Relationship",
    viewRegisterCta: "View Custody Register",
    noRelationships:
      "No custodied relationships yet. Protect your first introduction.",
  },
} as const;


=== DASHBOARD.TSX IMPORTS (style reference) ===
import { useAuth } from "@/_core/hooks/useAuth";
import { EmptyState, EMPTY_STATES } from "@/components/EmptyState";
import { trpc } from "@/lib/trpc";
import { useDemoFixtures } from "@/contexts/DemoContext";
import { formatDistanceToNow } from "date-fns";
import {
  FileText,
  Lock,
  Shield,
  Target,
  TrendingUp,
  Clock,
  Fingerprint,
  CheckCircle,
  XCircle,
  Info,
} from "lucide-react";
import { Link } from "wouter";
import { useCallback, useEffect, useState } from "react";
import { motion } from "framer-motion";
import { FadeInView, StaggerContainer, StaggerItem } from "@/components/PageTransition";
import { SmoothCounter } from "@/components/PremiumAnimations";
import { toast } from "sonner";
import { DASHBOARD, NOTIFICATIONS, TOASTS } from "@/lib/copy";

// --- Assuming DEMO_FIXTURES in client/src/lib/demoFixtures.ts is updated as follows: ---
// interface DemoMatch { id: number; tag: string; compatibilityScore: number; assetClass: string; dealSize: string; intentType?: 'buy' | 'sell' | 'invest'; }
// interface DemoDealRoom { id: number; name: string; stage: string; counterparty: string; escrowProgress: number; auditEvents: number; documentCount: number; }
// interface DemoPayout { id: number; deal: string; amount: number; status: string; originatorShare: number; }
// interface DemoRelationship { id: number; name: string; custodyHash: string; custodyDate: string; attributionStatus: string; }
// interface DemoIntent { id: number; type: 'buy' | 'sell' | 'invest'; assetClass: string; size: string; }
// DEMO_FIXTURES should also include a 'relationships' and 'intents' array.
// -----------------------------------------------------------------------------------

const NOTIFICATION_STYLES: Record<
  string,
  { border: string; badge: string; label: string }
> = {
  match_found: {
    border: "border-l-[#C4972A]",
    badge: "bg-[#C4972A]/15 text-[#C4972A]",
    label: NOTIFICATIONS.matchFound.label,
  },
  deal_update: {
    border: "border-l-[#2563EB]",
    badge: "bg-[#2563EB]/15 text-[#2563EB]",
    label: NOTIFICATIONS.dealUpdate.label,
  },
  payout_received: {
    border: "border-l-[#059669]",
    badge: "bg-[#059669]/15 text-[#059669]",
    label: NOTIFICATIONS.payoutReceived.label,
  },
  compliance_alert: {
    border: "border-l-[#1E3A5F]",
    badge: "bg-[#1E3A5F]/15 text-[#1E3A5F]",
    label: NOTIFICATIONS.complianceAlert.label,
  },
};



=== SOURCE FILE: client/src/pages/DealRooms.tsx ===
import { useState, useMemo, useEffect } from "react";
import { trpc } from "@/lib/trpc";
import { EmptyState, EMPTY_STATES } from "@/components/EmptyState";
import {
  FolderOpen, Clock, ChevronRight,
  Lock, Download, Eye
} from "lucide-react";
import { useLocation } from "wouter";
import { FadeInView, ScaleHover, StaggerContainer, StaggerItem } from "@/components/PageTransition";

type StatusFilter = "all" | "nda_pending" | "active" | "diligence" | "closing" | "completed" | "declined";

const STATUS_FILTERS: { key: StatusFilter; label: string; className: string }[] = [
  { key: "all", label: "All", className: "" },
  { key: "nda_pending", label: "NDA Pending", className: "status-nda-pending" },
  { key: "active", label: "Active", className: "status-active" },
  { key: "diligence", label: "Diligence", className: "status-diligence" },
  { key: "closing", label: "Closing", className: "status-closing" },
  { key: "completed", label: "Completed", className: "status-completed" },
  { key: "declined", label: "Declined", className: "status-declined" },
];

const BADGE = "rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider";

function getStatusClass(status: string | null): string {
  switch (status) {
    case "active":
      return `bg-[#22D4F5]/10 text-[#22D4F5]/80 ${BADGE}`;
    case "closed":
      return `bg-[#059669]/15 text-[#059669] ${BADGE}`;
    case "archived":
      return `bg-[#6B7280]/15 text-[#6B7280] ${BADGE}`;
    default:
      return `bg-[#F59E0B]/15 text-[#F59E0B] ${BADGE}`;
  }
}

function getStatusLabel(status: string | null): string {
  switch (status) {
    case "active": return "Active";
    case "closed": return "Completed";
    case "archived": return "Declined";
    default: return "NDA Pending";
  }
}

function daysSince(date: Date | string): number {
  const d = typeof date === "string" ? new Date(date) : date;
  return Math.floor((Date.now() - d.getTime()) / (1000 * 60 * 60 * 24));
}

function formatRelativeTime(date: Date | string): string {
  const d = typeof date === "string" ? new Date(date) : date;
  const diffMs = Date.now() - d.getTime();
  const diffMin = Math.floor(diffMs / 60000);
  if (diffMin < 60) return `${diffMin}m ago`;
  const diffHr = Math.floor(diffMin / 60);
  if (diffHr < 24) return `${diffHr}h ago`;
  const diffDay = Math.floor(diffHr / 24);
  if (diffDay < 30) return `${diffDay}d ago`;
  return d.toLocaleDateString();
}

export default function DealRooms() {
  const [, setLocation] = useLocation();
  const [filter, setFilter] = useState<StatusFilter>("all");
  const { data: dealRooms, isLoading } = trpc.dealRoom.list.useQuery();

  const stats = useMemo(() => {
    if (!dealRooms) return { active: 0, pendingNda: 0, completed: 0, total: 0 };
    return {
      active: dealRooms.filter(r => r.status === "active").length,
      pendingNda: dealRooms.filter(r => !r.status || r.status === null).length,
      completed: dealRooms.filter(r => r.status === "closed").length,
      total: dealRooms.length,
    };
  }, [dealRooms]);

  const filtered = useMemo(() => {
    if (!dealRooms) return [];
    if (filter === "all") return dealRooms;
    const mapping: Record<StatusFilter, (r: any) => boolean> = {
      all: () => true,
      nda_pending: r => !r.status || r.status === null,
      active: r => r.status === "active",
      diligence: r => false,
      closing: r => false,
      completed: r => r.status === "closed",
      declined: r => r.status === "archived",
    };
    return dealRooms.filter(mapping[filter]);
  }, [dealRooms, filter]);

  useEffect(() => { document.title = "Deal Rooms | ANAVI"; }, []);

  return (
    <div className="p-8 space-y-6 animate-fade-in">
      {/* Header */}
      <FadeInView>
        <h1 className="dash-heading text-3xl">Deal Rooms</h1>
      </FadeInView>

      {/* Stats Row */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {[
          { label: "Active Rooms", value: stats.active, color: "#2563EB" },
          { label: "Pending NDA", value: stats.pendingNda, color: "#C4972A" },
          { label: "Completed", value: stats.completed, color: "#059669" },
          { label: "Total Value", value: `$${(stats.total * 2.5).toFixed(1)}M`, color: "#0A1628" },
        ].map((s) => (
          <div
            key={s.label}
            className="card-elevated p-5"
          >
            <div className="text-label text-muted-foreground mb-1">{s.label}</div>
            <div className="text-2xl font-bold number-display" style={{ color: s.color }}>
              {s.value}
            </div>
          </div>
        ))}
      </div>

      {/* Filter Bar */}
      <div className="card-elevated p-1.5 flex flex-wrap gap-1">
        {STATUS_FILTERS.map((sf) => {
          const isActive = filter === sf.key;
          return (
            <button
              key={sf.key}
              onClick={() => setFilter(sf.key)}
              className={
                isActive
                  ? "rounded-md px-3 py-1.5 text-xs font-semibold bg-[#0A1628] text-white cursor-pointer transition-all"
                  : "rounded-md px-3 py-1.5 text-xs font-medium text-[#1E3A5F]/60 hover:text-[#0A1628] hover:bg-[#0A1628]/5 cursor-pointer transition-all"
              }
            >
              {sf.label}
            </button>
          );
        })}
      </div>

      {/* Deal Room Cards */}
      {isLoading ? (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="card-elevated p-6">
              <div className="h-40 animate-shimmer rounded-lg" />
            </div>
          ))}
        </div>
      ) : filtered.length === 0 ? (
        <div className="card-elevated p-6">
          <EmptyState {...EMPTY_STATES.dealRooms} />
        </div>
      ) : (
        <StaggerContainer className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filtered.map((room) => {
            const settings = (room.settings as any) || {};
            const days = daysSince(room.createdAt);
            const lastActivity = formatRelativeTime(room.updatedAt || room.createdAt);

            return (
              <StaggerItem key={room.id}>
              <ScaleHover>
              <div className="card-elevated flex flex-col hover:translate-y-[-2px]">
                <div className="p-5 flex-1 space-y-3">
                  {/* Status pill */}
                  <div className="flex justify-end">
                    <span className={`inline-flex ${getStatusClass(room.status)}`}>
                      {getStatusLabel(room.status)}
                    </span>
                  </div>

                  {/* Room name */}
                  <h3 className="font-semibold text-base" style={{ color: "#0A1628" }}>
                    {room.name}
                  </h3>

                  {/* Parties (anonymized) */}
                  <div className="text-sm text-muted-foreground">
                    <span className="font-medium">Party A</span>
                    {" ↔ "}
                    <span className="font-medium">Party B</span>
                  </div>

                  {/* Meta row */}
                  <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-muted-foreground">
                    <span className="flex items-center gap-1">
                      <Clock className="w-3.5 h-3.5" />
                      {days}d in room
                    </span>
                    <span>Last: <span className="font-data-hud text-[10px] text-[#1E3A5F]/50">{lastActivity}</span></span>
                  </div>

                  {/* Badges */}
                  <div className="flex flex-wrap gap-1.5 pt-1">
                    {room.ndaRequired && (
                      <span className="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-medium bg-orange-50 text-orange-700">
                        <Lock className="w-3 h-3" />
                        NDA Required
                      </span>
                    )}
                    {settings.watermarkDocuments && (
                      <span className="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-medium bg-blue-50 text-blue-700">
                        <Eye className="w-3 h-3" />
                        Watermarking
                      </span>
                    )}
                    {settings.allowDownloads === false && (
                      <span className="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-medium bg-red-50 text-red-700">
                        <Download className="w-3 h-3" />
                        Download Controls
                      </span>
                    )}
                  </div>
                </div>

                {/* CTA */}
                <div className="px-5 pb-5 pt-2">
                  <button
                    onClick={() => setLocation(`/deal-rooms/${room.id}`)}
                    className="w-full flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-medium text-white transition-colors"
                    style={{ background: "#2563EB" }}
                  >
                    Enter Room
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
              </div>
              </ScaleHover>
              </StaggerItem>
            );
          })}
        </StaggerContainer>
      )}
    </div>
  );
}


=== INSTRUCTIONS ===

Your task: upgrade DealRooms.tsx for whitepaper vision conformance.

SPECIFIC ISSUES TO FIX:
1. The status filter buttons include "Diligence" and "Closing" but the filter logic
   never matches them. The schema statuses are: "active", "closed", "archived".
   Update the filter mapping:
   - "Active" -> status === "active"
   - "Diligence" -> REMOVE this filter button (dead code, schema has no diligence status)
   - "Closing" -> REMOVE this filter button (dead code, schema has no closing status)
   - "Completed" -> status === "closed"
   - "Declined" -> status === "archived"
   Keep: All, NDA Pending, Active, Completed, Declined filters.
2. The "Total Value" stat card uses stats.total * 2.5 -- this is fake data.
   Replace with: show stats.total as a count, rename stat card to "Total Rooms".
3. Add a subtitle under the "Deal Rooms" page heading:
   "NDA-gated workspaces. Immutable audit trail active on every room."
4. In each deal room card, under the room name, add a small text line:
   "Every document access and signature is cryptographically logged."
   Style: text-[10px] text-[#1E3A5F]/50

DO NOT CHANGE: All trpc.dealRoom.list wiring, the card grid layout, status pills,
"Enter Room" CTAs, NDA/Watermarking/Download Controls badges.



=== OUTPUT FORMAT ===
Respond with ONLY valid JSON (no markdown, no code blocks):
{
  "upgraded_tsx": "<complete upgraded TypeScript/TSX file content>",
  "changes_summary": ["change 1", "change 2"],
  "whitepaper_terms_added": ["term 1", "term 2"],
  "copy_tokens_used": ["DASHBOARD.xxx", "TOUR.xxx"]
}

CRITICAL RULES:
1. upgraded_tsx must be the COMPLETE file — do not truncate.
2. Preserve ALL existing tRPC queries and mutations — do not remove any.
3. Preserve ALL existing form logic, modals, validation.
4. Only change: copy/labels, visual aesthetics, terminology alignment.
5. Do not add new tRPC queries unless explicitly instructed.
6. TypeScript must compile — no implicit any, no missing imports.
7. Only import from libraries already in the project: react, wouter, framer-motion,
   lucide-react, sonner, date-fns, @/lib/trpc, @/lib/copy, @/components/ui/*,
   @/components/EmptyState, @/components/PageTransition, @/components/PremiumAnimations,
   @/_core/hooks/useAuth.