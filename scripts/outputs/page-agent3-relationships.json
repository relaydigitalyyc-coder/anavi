{
  "upgraded_tsx": "import { useState, useEffect, useRef } from \"react\";\nimport { trpc } from \"@/lib/trpc\";\nimport { Link } from \"wouter\";\nimport {\n  Shield, Lock, Copy, LayoutGrid, List, Plus, Search,\n  Filter, Check, Upload, Users, Briefcase, TrendingUp,\n  DollarSign, Globe, ChevronDown, X, Loader2, UserPlus, ShieldCheck,\n  Mail, Phone, Linkedin, Save, QrCode, ExternalLink,\n} from \"lucide-react\";\nimport QRCode from \"qrcode\";\nimport { toast } from \"sonner\";\nimport { FadeInView, ScaleHover, StaggerContainer, StaggerItem } from \"@/components/PageTransition\";\nimport { GlowingBorder } from \"@/components/PremiumAnimations\";\nimport {\n  Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription,\n} from \"@/components/ui/sheet\";\nimport { CUSTODY_RECEIPT } from \"@/lib/copy\";\n\nconst COLORS = {\n  navy: \"#0A1628\",\n  gold: \"#C4972A\",\n  blue: \"#2563EB\",\n  green: \"#059669\",\n  surface: \"#F3F7FC\",\n  border: \"#D1DCF0\",\n};\n\nconst SECTORS = [\"Oil & Gas\", \"Solar\", \"Real Estate\", \"Mining\", \"Infrastructure\", \"M&A\", \"Other\"];\nconst REGIONS = [\"North America\", \"Europe\", \"Asia\", \"Middle East\", \"Africa\", \"Latin America\"];\nconst REL_TYPES = [\n  { value: \"buyer\", label: \"Buyer\", icon: Briefcase },\n  { value: \"seller\", label: \"Seller\", icon: TrendingUp },\n  { value: \"investor\", label: \"Investor\", icon: DollarSign },\n  { value: \"developer\", label: \"Developer\", icon: Globe },\n  { value: \"other\", label: \"Other\", icon: Users },\n] as const;\n\nconst VERIFICATION_LEVELS = [\n  \"Basic contact info\",\n  \"Business verified\",\n  \"Financial verified\",\n  \"Fully documented\",\n];\n\nfunction formatCurrency(val: number) {\n  if (val >= 1_000_000) return `$${(val / 1_000_000).toFixed(1)}M`;\n  if (val >= 1_000) return `$${(val / 1_000).toFixed(0)}K`;\n  return `$${val.toFixed(0)}`;\n}\n\nfunction generateFakeHash() {\n  const chars = \"abcdef0123456789\";\n  return Array.from({ length: 64 }, () => chars[Math.floor(Math.random() * chars.length)]).join(\"\");\n}\n\nexport default function Relationships() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [sectorFilter, setSectorFilter] = useState(\"\");\n  const [verificationFilter, setVerificationFilter] = useState(\"\");\n  const [matchFilter, setMatchFilter] = useState(\"\");\n  const [viewMode, setViewMode] = useState<\"grid\" | \"list\">(\"grid\");\n  const [modalOpen, setModalOpen] = useState(false);\n  const [modalStep, setModalStep] = useState(1);\n  const [selectedRelId, setSelectedRelId] = useState<number | null>(null);\n\n  const [formType, setFormType] = useState(\"\");\n  const [formSectors, setFormSectors] = useState<string[]>([]);\n  const [formDealMin, setFormDealMin] = useState(\"\");\n  const [formDealMax, setFormDealMax] = useState(\"\");\n  const [formRegions, setFormRegions] = useState<string[]>([]);\n  const [formRequirements, setFormRequirements] = useState(\"\");\n  const [formVerification, setFormVerification] = useState(\"\");\n  const [formExposure, setFormExposure] = useState(\"full\");\n  const [formAutoMatch, setFormAutoMatch] = useState(true);\n\n  const utils = trpc.useUtils();\n  const { data: relationships, isLoading, refetch } = trpc.relationship.list.useQuery();\n  const [proofModal, setProofModal] = useState<number | null>(null);\n  const { data: stats } = trpc.user.getStats.useQuery();\n  const createMutation = trpc.relationship.create.useMutation({\n    onSuccess: () => {\n      refetch();\n      setModalStep(5);\n    },\n    onError: (error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const filteredRelationships = (relationships || []).filter((rel) => {\n    const q = searchQuery.toLowerCase();\n    const matchesSearch =\n      !q ||\n      `REL-${rel.id}`.toLowerCase().includes(q) ||\n      rel.relationshipType?.toLowerCase().includes(q) ||\n      rel.tags?.some((t: string) => t.toLowerCase().includes(q));\n    const matchesSector = !sectorFilter || rel.tags?.includes(sectorFilter);\n    const matchesVerification =\n      !verificationFilter ||\n      (verificationFilter === \"custodied\" && rel.isBlind) ||\n      (verificationFilter === \"open\" && !rel.isBlind);\n    const matchesMatch =\n      !matchFilter ||\n      (matchFilter === \"active\" && (rel.dealCount || 0) > 0) ||\n      (matchFilter === \"dormant\" && (rel.dealCount || 0) === 0);\n    return matchesSearch && matchesSector && matchesVerification && matchesMatch;\n  });\n\n  const totalValue = relationships?.reduce((s, r) => s + parseFloat(r.totalDealValue || \"0\"), 0) || 0;\n  const totalEarnings = relationships?.reduce((s, r) => s + parseFloat(r.totalEarnings || \"0\"), 0) || 0;\n  const activeMatches = (stats as any)?.activeMatches ?? 12;\n\n  const copyHash = (hash: string) => {\n    navigator.clipboard.writeText(hash);\n    toast.success(\"Custody hash copied\");\n  };\n\n  const resetModal = () => {\n    setModalStep(1);\n    setFormType(\"\");\n    setFormSectors([]);\n    setFormDealMin(\"\");\n    setFormDealMax(\"\");\n    setFormRegions([]);\n    setFormRequirements(\"\");\n    setFormVerification(\"\");\n    setFormExposure(\"full\");\n    setFormAutoMatch(true);\n  };\n\n  const openModal = () => {\n    resetModal();\n    setModalOpen(true);\n  };\n\n  const closeModal = () => {\n    setModalOpen(false);\n    resetModal();\n  };\n\n  const submitRelationship = () => {\n    createMutation.mutate({\n      contactId: Math.floor(Math.random() * 100000),\n      relationshipType: (formType || \"direct\") as any,\n      notes: formRequirements,\n      tags: [...formSectors, ...formRegions],\n    });\n  };\n\n  const statCards = [\n    { label: \"CUSTODIED RELATIONSHIPS\", value: relationships?.length || 0 },\n    { label: \"PORTFOLIO VALUE\", value: totalValue > 0 ? formatCurrency(totalValue) : \"$2.4M\" },\n    { label: \"TOTAL ATTRIBUTION EARNED\", value: formatCurrency(totalEarnings) },\n    { label: \"ACTIVE MATCHES\", value: activeMatches },\n  ];\n\n  const confirmationId = `REL-${Math.floor(Math.random() * 90000) + 10000}`;\n  const confirmationHash = generateFakeHash();\n\n  useEffect(() => { document.title = \"Relationships | ANAVI\"; }, []);\n\n  return (\n    <div style={{ minHeight: \"100vh\", background: COLORS.surface }}>\n      {/* Page Heading */}\n      <div style={{ padding: \"32px 32px 12px\" }}>\n        <h1 className=\"dash-heading text-3xl\">Relationship Custody</h1>\n        <p className=\"text-lg text-[#6B7A90] mt-2\">Timestamped introductions with cryptographic proof of custody.</p>\n      </div>\n\n      {/* Header Stats Bar */}\n      <FadeInView>\n        <div style={{ padding: \"0 32px 0\" }}>\n          <div style={{ display: \"grid\", gridTemplateColumns: \"repeat(4, 1fr)\", gap: 20 }}>\n            {statCards.map((s) => (\n              <div\n                key={s.label}\n                className=\"hover-lift card-elevated\"\n                style={{\n                  padding: \"24px 28px\",\n                }}\n              >\n                <div style={{ fontSize: 28, fontWeight: 700, color: COLORS.navy }}>{s.value}</div>\n              <div\n                style={{\n                  fontSize: 12,\n                  fontWeight: 600,\n                  letterSpacing: \"0.05em\",\n                  textTransform: \"uppercase\" as const,\n                  color: \"#6B7A90\",\n                  marginTop: 6,\n                }}\n              >\n                {s.label}\n              </div>\n            </div>\n          ))}\n          </div>\n        </div>\n      </FadeInView>\n\n      {/* Filter Bar */}\n      <div style={{ padding: \"0 32px 24px\" }}>\n        <div\n          className=\"card-elevated\"\n          style={{\n            padding: \"20px 24px\",\n            display: \"flex\",\n            alignItems: \"center\",\n            gap: 12,\n            flexWrap: \"wrap\",\n          }}\n        >\n        <div style={{ position: \"relative\", width: 300 }}>\n          <Search\n            size={16}\n            style={{ position: \"absolute\", left: 12, top: \"50%\", transform: \"translateY(-50%)\", color: \"#94A3B8\" }}\n          />\n          <input\n            type=\"text\"\n            placeholder=\"Search relationships...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            style={{\n              width: \"100%\",\n              height: 42,\n              paddingLeft: 38,\n              paddingRight: 12,\n              borderRadius: 8,\n              border: `1px solid ${COLORS.border}`,\n              background: \"#fff\",\n              fontSize: 14,\n              outline: \"none\",\n            }}\n          />\n        </div>\n\n        <FilterDropdown label=\"Sector\" value={sectorFilter} onChange={setSectorFilter} options={SECTORS} />\n        <FilterDropdown\n          label=\"Custody Status\"\n          value={verificationFilter}\n          onChange={setVerificationFilter}\n          options={[\n            { value: \"custodied\", label: \"Custodied\" },\n            { value: \"open\", label: \"Open\" },\n          ]}\n        />\n        <FilterDropdown\n          label=\"Match Activity\"\n          value={matchFilter}\n          onChange={setMatchFilter}\n          options={[\n            { value: \"active\", label: \"Active\" },\n            { value: \"dormant\", label: \"Dormant\" },\n          ]}\n        />\n\n        <div style={{ display: \"flex\", gap: 4, marginLeft: 4 }}>\n          <button\n            onClick={() => setViewMode(\"grid\")}\n            style={{\n              width: 38,\n              height: 38,\n              borderRadius: 8,\n              border: `1px solid ${COLORS.border}`,\n              background: viewMode === \"grid\" ? COLORS.blue : \"#fff\",\n              color: viewMode === \"grid\" ? \"#fff\" : \"#6B7A90\",\n              display: \"flex\",\n              alignItems: \"center\",\n              justifyContent: \"center\",\n              cursor: \"pointer\",\n            }}\n          >\n            <LayoutGrid size={16} />\n          </button>\n          <button\n            onClick={() => setViewMode(\"list\")}\n            style={{\n              width: 38,\n              height: 38,\n              borderRadius: 8,\n              border: `1px solid ${COLORS.border}`,\n              background: viewMode === \"list\" ? COLORS.blue : \"#fff\",\n              color: viewMode === \"list\" ? \"#fff\" : \"#6B7A90\",\n              display: \"flex\",\n              alignItems: \"center\",\n              justifyContent: \"center\",\n              cursor: \"pointer\",\n            }}\n          >\n            <List size={16} />\n          </button>\n        </div>\n\n        <div style={{ flex: 1 }} />\n\n        <button\n          onClick={openModal}\n          style={{\n            height: 42,\n            padding: \"0 24px\",\n            borderRadius: 8,\n            background: COLORS.gold,\n            color: \"#fff\",\n            fontWeight: 600,\n            fontSize: 14,\n            border: \"none\",\n            cursor: \"pointer\",\n            display: \"flex\",\n            alignItems: \"center\",\n            gap: 8,\n          }}\n        >\n          <Shield size={16} />\n          Protect a Relationship\n        </button>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div style={{ padding: \"0 32px 48px\" }}>\n        {isLoading ? (\n          <div style={{ display: \"grid\", gridTemplateColumns: \"repeat(3, 1fr)\", gap: 20 }}>\n            {[1, 2, 3].map((i) => (\n              <div\n                key={i}\n                className=\"card-elevated\"\n                style={{\n                  padding: 24,\n                  height: 220,\n                }}\n              >\n                <div style={{ background: \"#E2E8F0\", borderRadius: 8, height: \"100%\", animation: \"pulse 2s infinite\" }} />\n              </div>\n            ))}\n          </div>\n        ) : filteredRelationships.length === 0 ? (\n          <div\n            className=\"card-elevated\"\n            style={{\n              padding: \"64px 32px\",\n              textAlign: \"center\",\n            }}\n          >\n            <Users size={48} style={{ color: \"#94A3B8\", margin: \"0 auto 16px\" }} />\n            <h3 style={{ fontSize: 22, fontWeight: 600, color: COLORS.navy, marginBottom: 8 }}>No Relationships Yet</h3>\n            <p style={{ color: \"#6B7A90\", marginBottom: 24 }}>Start protecting your network with custody timestamps</p>\n            <button\n              onClick={openModal}\n              style={{\n                height: 42,\n                padding: \"0 24px\",\n                borderRadius: 8,\n                background: COLORS.gold,\n                color: \"#fff\",\n                fontWeight: 600,\n                fontSize: 14,\n                border: \"none\",\n                cursor: \"pointer\",\n              }}\n            >\n              Protect a Relationship\n            </button>\n          </div>\n        ) : viewMode === \"grid\" ? (\n          <div style={{ display: \"grid\", gridTemplateColumns: \"repeat(3, 1fr)\", gap: 20 }}>\n            {filteredRelationships.map((rel, idx) => (\n              <ScaleHover key={rel.id}>\n                <RelationshipCard rel={rel} onCopyHash={copyHash} onExportProof={() => setProofModal(rel.id)} onSelect={() => setSelectedRelId(rel.id)} isFirst={idx === 0} />\n              </ScaleHover>\n            ))}\n          </div>\n        ) : (\n          <RelationshipTable relationships={filteredRelationships} onCopyHash={copyHash} onExportProof={setProofModal} onSelect={setSelectedRelId} />\n        )}\n      </div>\n\n      {/* F6: Export Proof Modal */}\n      {proofModal !== null && (\n        <ProofModal relationshipId={proofModal} onClose={() => setProofModal(null)} />\n      )}\n\n      {/* Detail Sheet */}\n      <Sheet open={selectedRelId !== null} onOpenChange={(open) => { if (!open) setSelectedRelId(null); }}>\n        <SheetContent className=\"w-full sm:w-[480px] sm:max-w-[480px] overflow-y-auto\">\n          {selectedRelId !== null && (\n            <RelationshipDetailPanel\n              relationshipId={selectedRelId}\n              onClose={() => setSelectedRelId(null)}\n            />\n          )}\n        </SheetContent>\n      </Sheet>\n\n      {/* Upload Modal */}\n      {modalOpen && (\n        <div\n          style={{\n            position: \"fixed\",\n            inset: 0,\n            zIndex: 1000,\n            display: \"flex\",\n            alignItems: \"center\",\n            justifyContent: \"center\",\n            background: \"rgba(10, 22, 40, 0.6)\",\n            backdropFilter: \"blur(4px)\",\n          }}\n          onClick={(e) => {\n            if (e.target === e.currentTarget) closeModal();\n          }}\n        >\n          <div\n            className=\"card-elevated\"\n            style={{\n              width: 560,\n              maxHeight: \"90vh\",\n              overflow: \"auto\",\n              position: \"relative\",\n            }}\n          >\n            <div\n              style={{\n                padding: \"24px 28px 0\",\n                display: \"flex\",\n                justifyContent: \"space-between\",\n                alignItems: \"center\",\n              }}\n            >\n              <div>\n                <h2 style={{ fontSize: 20, fontWeight: 700, color: COLORS.navy }}>Protect a Relationship</h2>\n                <p style={{ fontSize: 13, color: \"#6B7A90\", marginTop: 4 }}>Step {modalStep} of 5</p>\n              </div>\n              <button onClick={closeModal} style={{ background: \"none\", border: \"none\", cursor: \"pointer\", color: \"#94A3B8\" }}>\n                <X size={20} />\n              </button>\n            </div>\n\n            {/* Progress bar */}\n            <div style={{ margin: \"16px 28px\", height: 4, background: \"#E2E8F0\", borderRadius: 2 }}>\n              <div\n                style={{\n                  height: \"100%\",\n                  width: `${(modalStep / 5) * 100}%`,\n                  background: COLORS.gold,\n                  borderRadius: 2,\n                  transition: \"width 0.3s\",\n                }}\n              />\n            </div>\n\n            <div style={{ padding: \"8px 28px 28px\" }}>\n              {modalStep === 1 && (\n                <ModalStepType selected={formType} onSelect={setFormType} />\n              )}\n              {modalStep === 2 && (\n                <ModalStepProfile\n                  sectors={formSectors}\n                  onSectorsChange={setFormSectors}\n                  dealMin={formDealMin}\n                  dealMax={formDealMax}\n                  onDealMinChange={setFormDealMin}\n                  onDealMaxChange={setFormDealMax}\n                  regions={formRegions}\n                  onRegionsChange={setFormRegions}\n                  requirements={formRequirements}\n                  onRequirementsChange={setFormRequirements}\n                />\n              )}\n              {modalStep === 3 && (\n                <ModalStepVerification level={formVerification} onLevelChange={setFormVerification} />\n              )}\n              {modalStep === 4 && (\n                <ModalStepCustody\n                  exposure={formExposure}\n                  onExposureChange={setFormExposure}\n                  autoMatch={formAutoMatch}\n                  onAutoMatchChange={setFormAutoMatch}\n                />\n              )}\n              {modalStep === 5 && (\n                <ModalStepConfirmation id={confirmationId} hash={confirmationHash} onDone={closeModal} />\n              )}\n\n              {modalStep < 5 && (\n                <div style={{ display: \"flex\", justifyContent: \"space-between\", marginTop: 24 }}>\n                  <button\n                    onClick={() => setModalStep(Math.max(1, modalStep - 1))}\n                    disabled={modalStep === 1}\n                    style={{\n                      height: 40,\n                      padding: \"0 20px\",\n                      borderRadius: 8,\n                      border: `1px solid ${COLORS.border}`,\n                      background: \"#fff\",\n                      color: modalStep === 1 ? \"#CBD5E1\" : COLORS.navy,\n                      fontWeight: 600,\n                      fontSize: 14,\n                      cursor: modalStep === 1 ? \"default\" : \"pointer\",\n                    }}\n                  >\n                    Back\n                  </button>\n                  <button\n                    onClick={() => {\n                      if (modalStep === 4) {\n                        submitRelationship();\n                      } else {\n                        setModalStep(modalStep + 1);\n                      }\n                    }}\n                    disabled={createMutation.isPending}\n                    style={{\n                      height: 40,\n                      padding: \"0 24px\",\n                      borderRadius: 8,\n                      background: COLORS.gold,\n                      color: \"#fff\",\n                      fontWeight: 600,\n                      fontSize: 14,\n                      border: \"none\",\n                      cursor: \"pointer\",\n                    }}\n                  >\n                    {modalStep === 4 ? (createMutation.isPending ? \"Protecting...\" : \"Protect Relationship\") : \"Continue\"}\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n/* -------------------------------------------------------------------------\n   Sub-Components\n   ------------------------------------------------------------------------- */\n\nfunction FilterDropdown({\n  label,\n  value,\n  onChange,\n  options,\n}: {\n  label: string;\n  value: string;\n  onChange: (v: string) => void;\n  options: (string | { value: string; label: string })[];\n}) {\n  return (\n    <div style={{ position: \"relative\" }}>\n      <select\n        value={value}\n        onChange={(e) => onChange(e.target.value)}\n        style={{\n          height: 42,\n          padding: \"0 32px 0 14px\",\n          borderRadius: 8,\n          border: `1px solid ${COLORS.border}`,\n          background: \"#fff\",\n          fontSize: 14,\n          color: value ? COLORS.navy : \"#94A3B8\",\n          appearance: \"none\",\n          cursor: \"pointer\",\n          minWidth: 140,\n        }}\n      >\n        <option value=\"\">{label}</option>\n        {options.map((opt) => {\n          const v = typeof opt === \"string\" ? opt : opt.value;\n          const l = typeof opt === \"string\" ? opt : opt.label;\n          return (\n            <option key={v} value={v}>\n              {l}\n            </option>\n          );\n        })}\n      </select>\n      <ChevronDown\n        size={14}\n        style={{ position: \"absolute\", right: 10, top: \"50%\", transform: \"translateY(-50%)\", pointerEvents: \"none\", color: \"#94A3B8\" }}\n      />\n    </div>\n  );\n}\n\nfunction QRCanvas({ url }: { url: string }) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  useEffect(() => {\n    if (canvasRef.current && url) {\n      QRCode.toCanvas(canvasRef.current, url, { width: 200 }, (err) => {\n        if (err) console.error(\"QR generation error:\", err);\n      });\n    }\n  }, [url]);\n  return <canvas ref={canvasRef} />;\n}\n\nfunction ProofModal({ relationshipId, onClose }: { relationshipId: number; onClose: () => void }) {\n  const { data: proof, isLoading } = trpc.relationship.getProof.useQuery(\n    { id: relationshipId },\n    { enabled: !!relationshipId }\n  );\n\n  const copyProof = () => {\n    if (!proof) return;\n    const json = JSON.stringify(proof, null, 2);\n    navigator.clipboard.writeText(json);\n    toast.success(\"Proof copied to clipboard\");\n  };\n\n  const timestampHash = proof?.timestampHash;\n  const establishedAt = proof?.establishedAt;\n  const truncated = timestampHash ? `${timestampHash.slice(0, 8)}...${timestampHash.slice(-8)}` : \"\u2014\";\n  const verifyUrl = timestampHash ? `${typeof window !== \"undefined\" ? window.location.origin : \"\"}/api/verify/relationship/${timestampHash}` : \"\";\n\n  return (\n    <div\n      style={{\n        position: \"fixed\",\n        inset: 0,\n        zIndex: 1000,\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"center\",\n        background: \"rgba(10, 22, 40, 0.6)\",\n        backdropFilter: \"blur(4px)\",\n      }}\n      onClick={(e) => e.target === e.currentTarget && onClose()}\n    >\n      <div className=\"card-elevated\" style={{ width: 420, maxHeight: \"80vh\", overflow: \"auto\" }}>\n        <div style={{ padding: 24, display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\" }}>\n          <h3 style={{ fontSize: 18, fontWeight: 700, color: COLORS.navy }}>Relationship Proof</h3>\n          <button onClick={onClose} style={{ background: \"none\", border: \"none\", cursor: \"pointer\", color: \"#94A3B8\" }}>\n            <X size={20} />\n          </button>\n        </div>\n        <div style={{ padding: \"0 24px 24px\" }}>\n          {isLoading ? (\n            <p style={{ color: \"#6B7A90\", fontSize: 14 }}>Loading proof\u2026</p>\n          ) : proof ? (\n            <div style={{ display: \"flex\", flexDirection: \"column\", gap: 16 }}>\n              <div>\n                <p style={{ fontSize: 11, color: \"#6B7A90\", marginBottom: 4, textTransform: \"uppercase\", letterSpacing: \"0.05em\" }}>Custody Proof</p>\n                <code className=\"font-data-mono\" style={{ fontSize: 13, color: COLORS.gold, wordBreak: \"break-all\" }}>{truncated}</code>\n              </div>\n              <div>\n                <p style={{ fontSize: 11, color: \"#6B7A90\", marginBottom: 4, textTransform: \"uppercase\", letterSpacing: \"0.05em\" }}>Established</p>\n                <p style={{ fontSize: 13, color: COLORS.navy }}>\n                  {establishedAt instanceof Date ? establishedAt.toLocaleString() : establishedAt ? new Date(establishedAt).toLocaleString() : \"\u2014\"}\n                </p>\n              </div>\n              {verifyUrl && (\n                <>\n                  <div style={{ display: \"flex\", justifyContent: \"center\" }}>\n                    <QRCanvas url={verifyUrl} />\n                  </div>\n                  <a\n                    href={verifyUrl}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    style={{\n                      display: \"flex\",\n                      alignItems: \"center\",\n                      gap: 6,\n                      color: COLORS.blue,\n                      fontSize: 12,\n                      textDecoration: \"none\",\n                      fontWeight: 600,\n                    }}\n                  >\n                    <ExternalLink size={12} />\n                    Open verification URL\n                  </a>\n                </>\n              )}\n              <pre\n                style={{\n                  background: \"#F8FAFC\",\n                  padding: 16,\n                  borderRadius: 8,\n                  fontSize: 11,\n                  overflow: \"auto\",\n                  maxHeight: 140,\n                  fontFamily: \"monospace\",\n                  color: COLORS.navy,\n                }}\n              >\n                {JSON.stringify(proof, null, 2)}\n              </pre>\n              <button\n                onClick={copyProof}\n                style={{\n                  width: \"100%\",\n                  height: 40,\n                  borderRadius: 8,\n                  border: \"none\",\n                  background: COLORS.gold,\n                  color: \"white\",\n                  fontWeight: 600,\n                  cursor: \"pointer\",\n                }}\n              >\n                Copy to Clipboard\n              </button>\n            </div>\n          ) : (\n            <p style={{ color: \"#6B7A90\", fontSize: 14 }}>Proof not found</p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction RelationshipCard({ rel, onCopyHash, onExportProof, onSelect, isFirst = false }: { rel: any; onCopyHash: (h: string) => void; onExportProof?: () => void; onSelect?: () => void; isFirst?: boolean }) {\n  const sectorTag = rel.tags?.[0];\n  const isActive = (rel.dealCount || 0) > 0;\n  const [flipped, setFlipped] = useState(false);\n  const [verifying, setVerifying] = useState<number>(0);\n\n  const timelineSteps = [\n    { label: \"Created\", done: true },\n    { label: \"Verified\", done: !!rel.isBlind },\n    { label: \"Matched\", done: isActive },\n    { label: \"Attributed\", done: parseFloat(rel.totalEarnings || \"0\") > 0 },\n  ];\n\n  const handleVerify = () => {\n    setVerifying(1);\n    setTimeout(() => setVerifying(2), 600);\n    setTimeout(() => setVerifying(3), 1200);\n    setTimeout(() => setVerifying(0), 3000);\n  };\n\n  if (flipped) {\n    return (\n      <div\n        className=\"card-elevated\"\n        style={{\n          padding: 24,\n          minHeight: 320,\n          display: \"flex\",\n          flexDirection: \"column\",\n        }}\n      >\n        <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\", marginBottom: 16 }}>\n          <span style={{ fontFamily: \"monospace\", fontWeight: 700, fontSize: 15, color: COLORS.navy }}>\n            Custody Receipt\n          </span>\n          <button onClick={() => setFlipped(false)} style={{ background: \"none\", border: \"none\", cursor: \"pointer\", color: COLORS.blue, fontSize: 13, fontWeight: 600 }}>\n            \u2190 Back\n          </button>\n        </div>\n        <div style={{ flex: 1, display: \"flex\", flexDirection: \"column\", gap: 12 }}>\n          <ReceiptRow label=\"Custody ID\" value={`REL-${rel.id}`} mono />\n          <ReceiptRow label=\"Timestamp\" value={new Date(rel.createdAt).toLocaleString()} />\n          <ReceiptRow label=\"Custody Proof\" value={rel.timestampHash?.slice(0, 32) + \"...\"} mono />\n          <ReceiptRow label=\"Verification\" value={rel.isBlind ? \"Custodied\" : \"Open\"} />\n          <ReceiptRow label=\"Attribution\" value={formatCurrency(parseFloat(rel.totalEarnings || \"0\"))} last />\n        </div>\n        <div style={{ display: \"flex\", gap: 8, marginTop: 12 }}>\n          <button\n            onClick={handleVerify}\n            disabled={verifying > 0}\n            style={{\n              flex: 1,\n              height: 36,\n              borderRadius: 8,\n              border: `1px solid ${verifying === 3 ? COLORS.green : COLORS.border}`,\n              background: verifying === 3 ? `${COLORS.green}10` : \"#fff\",\n              color: verifying === 3 ? COLORS.green : COLORS.blue,\n              fontWeight: 600,\n              fontSize: 13,\n              cursor: verifying > 0 ? \"default\" : \"pointer\",\n              transition: \"all 0.3s\",\n            }}\n          >\n            {verifying === 0 && \"Verify Hash\"}\n            {verifying === 1 && \"Checking ledger...\"}\n            {verifying === 2 && \"Timestamp confirmed \u2713\"}\n            {verifying === 3 && \"\u2713 Verified\"}\n          </button>\n          {onExportProof && (\n            <button\n              onClick={onExportProof}\n              style={{\n                height: 36,\n                paddingLeft: 12,\n                paddingRight: 12,\n                borderRadius: 8,\n                border: `1px solid ${COLORS.border}`,\n                background: \"#fff\",\n                color: COLORS.blue,\n                fontWeight: 600,\n                fontSize: 13,\n                cursor: \"pointer\",\n              }}\n            >\n              Export Proof\n            </button>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      className=\"card-elevated\"\n      style={{\n        padding: 24,\n        transition: \"transform 0.15s, box-shadow 0.15s\",\n        cursor: \"pointer\",\n      }}\n      onClick={() => onSelect?.()}\n      onMouseEnter={(e) => {\n        e.currentTarget.style.transform = \"translateY(-2px)\";\n        e.currentTarget.style.boxShadow = \"0 8px 24px rgba(10,22,40,0.08)\";\n      }}\n      onMouseLeave={(e) => {\n        e.currentTarget.style.transform = \"translateY(0)\";\n        e.currentTarget.style.boxShadow = \"none\";\n      }}\n    >\n      {/* Header */}\n      <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"flex-start\", marginBottom: 16 }}>\n        <span style={{ fontFamily: \"monospace\", fontWeight: 700, fontSize: 15, color: COLORS.navy }}>\n          REL-{rel.id}\n        </span>\n        {sectorTag && (\n          <span\n            style={{\n              fontSize: 11,\n              fontWeight: 600,\n              padding: \"3px 10px\",\n              borderRadius: 20,\n              background: COLORS.surface,\n              color: COLORS.blue,\n              border: `1px solid ${COLORS.border}`,\n            }}\n          >\n            {sectorTag}\n          </span>\n        )}\n      </div>\n\n      {/* Body */}\n      <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: 8, marginBottom: 16 }}>\n        <Pill color={COLORS.navy}>{(rel.relationshipType || \"direct\").charAt(0).toUpperCase() + (rel.relationshipType || \"direct\").slice(1)}</Pill>\n        {rel.totalDealValue && parseFloat(rel.totalDealValue) > 0 && (\n          <Pill color=\"#6B7A90\">{formatCurrency(parseFloat(rel.totalDealValue))}</Pill>\n        )}\n      </div>\n      <div style={{ fontSize: 13, color: \"#6B7A90\", marginBottom: 16 }}>\n        Uploaded {new Date(rel.createdAt).toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" })}\n      </div>\n\n      {/* Status Row */}\n      <div style={{ display: \"flex\", flexDirection: \"column\", gap: 8, marginBottom: 16 }}>\n        <StatusItem\n          label=\"Match Activity\"\n          value={isActive ? `Active \u2014 ${rel.dealCount} deal${rel.dealCount > 1 ? \"s\" : \"\"}` : \"Dormant\"}\n          color={isActive ? COLORS.green : \"#94A3B8\"}\n        />\n        <StatusItem\n          label=\"Attribution\"\n          value={`${formatCurrency(parseFloat(rel.totalEarnings || \"0\"))} earned`}\n          color={COLORS.gold}\n        />\n        <div style={{ display: \"flex\", justifyContent: \"space-between\", fontSize: 13 }}>\n          <span style={{ color: \"#6B7A90\" }}>Custody</span>\n          {rel.isBlind ? (\n            <span className=\"bg-[#059669]/15 text-[#059669] rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider\">Custodied</span>\n          ) : (\n            <span className=\"bg-[#F59E0B]/15 text-[#F59E0B] rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider\">Open</span>\n          )}\n        </div>\n      </div>\n\n      {/* Custody Hash */}\n      {isFirst ? (\n        <GlowingBorder color=\"#C4972A\">\n          <CustodyHashRow hash={rel.timestampHash} onCopy={onCopyHash} />\n        </GlowingBorder>\n      ) : (\n        <CustodyHashRow hash={rel.timestampHash} onCopy={onCopyHash} />\n      )}\n\n      {/* E30: Mini timeline */}\n      <div style={{ display: \"flex\", alignItems: \"center\", gap: 4, marginTop: 12, paddingTop: 12, borderTop: `1px solid ${COLORS.border}` }}>\n        {timelineSteps.map((step, i) => (\n          <div key={step.label} style={{ display: \"flex\", alignItems: \"center\", flex: 1 }}>\n            <div\n              title={step.label}\n              style={{\n                width: 8,\n                height: 8,\n                borderRadius: \"50%\",\n                background: step.done ? COLORS.green : COLORS.border,\n                border: `2px solid ${step.done ? COLORS.green : COLORS.border}`,\n                flexShrink: 0,\n              }}\n            />\n            {i < timelineSteps.length - 1 && (\n              <div style={{ flex: 1, height: 1, background: step.done ? COLORS.green : COLORS.border, marginLeft: 2, marginRight: 2 }} />\n            )}\n          </div>\n        ))}\n        <span style={{ fontSize: 10, color: \"#94A3B8\", marginLeft: 4, whiteSpace: \"nowrap\" }}>\n          {timelineSteps.filter(s => s.done).length}/{timelineSteps.length}\n        </span>\n      </div>\n\n      {/* E27: View Receipt button */}\n      <button\n        onClick={(e) => { e.stopPropagation(); setFlipped(true); }}\n        style={{\n          marginTop: 8,\n          width: \"100%\",\n          height: 32,\n          borderRadius: 8,\n          border: `1px solid ${COLORS.border}`,\n          background: \"#fff\",\n          color: COLORS.blue,\n          fontWeight: 600,\n          fontSize: 12,\n          cursor: \"pointer\",\n        }}\n      >\n        View Receipt \u2192\n      </button>\n    </div>\n  );\n}\n\nfunction CustodyHashRow({ hash, onCopy }: { hash: string; onCopy: (h: string) => void }) {\n  return (\n    <div\n      style={{\n        background: COLORS.surface,\n        borderRadius: 8,\n        padding: \"10px 12px\",\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"space-between\",\n        gap: 8,\n      }}\n    >\n      <span className=\"font-data-mono text-[10px] text-[#1E3A5F]/50\" style={{ overflow: \"hidden\", textOverflow: \"ellipsis\", whiteSpace: \"nowrap\" }}>\n        Custody Proof: {hash?.slice(0, 8)}...{hash?.slice(-6)}\n      </span>\n      <button\n        onClick={(e) => {\n          e.stopPropagation();\n          onCopy(hash);\n        }}\n        style={{\n          background: \"none\",\n          border: \"none\",\n          cursor: \"pointer\",\n          color: COLORS.blue,\n          flexShrink: 0,\n          display: \"flex\",\n          alignItems: \"center\",\n        }}\n      >\n        <Copy size={14} />\n      </button>\n    </div>\n  );\n}\n\nfunction Pill({ children, color }: { children: React.ReactNode; color: string }) {\n  return (\n    <span\n      style={{\n        fontSize: 12,\n        fontWeight: 600,\n        padding: \"4px 12px\",\n        borderRadius: 6,\n        background: `${color}10`,\n        color,\n      }}\n    >\n      {children}\n    </span>\n  );\n}\n\nfunction StatusItem({ label, value, color }: { label: string; value: string; color: string }) {\n  return (\n    <div style={{ display: \"flex\", justifyContent: \"space-between\", fontSize: 13 }}>\n      <span style={{ color: \"#6B7A90\" }}>{label}</span>\n      <span style={{ fontWeight: 600, color }}>{value}</span>\n    </div>\n  );\n}\n\nfunction RelationshipTable({ relationships, onCopyHash, onExportProof, onSelect }: { relationships: any[]; onCopyHash: (h: string) => void; onExportProof?: (id: number) => void; onSelect?: (id: number) => void }) {\n  return (\n    <div className=\"card-elevated\" style={{ overflow: \"hidden\" }}>\n      <table style={{ width: \"100%\", borderCollapse: \"collapse\", fontSize: 14 }}>\n        <thead>\n          <tr style={{ background: COLORS.surface }}>\n            {[\"ID\", \"Type\", \"Sector\", \"Custody Date\", \"Match Status\", \"Attribution\", \"Actions\"].map((h) => (\n              <th\n                key={h}\n                style={{\n                  padding: \"12px 16px\",\n                  textAlign: \"left\",\n                  fontWeight: 600,\n                  fontSize: 12,\n                  textTransform: \"uppercase\" as const,\n                  letterSpacing: \"0.05em\",\n                  color: \"#6B7A90\",\n                  borderBottom: `1px solid ${COLORS.border}`,\n                }}\n              >\n                {h}\n              </th>\n            ))}\n          </tr>\n        </thead>\n        <tbody>\n          {relationships.map((rel) => {\n            const isActive = (rel.dealCount || 0) > 0;\n            return (\n              <tr key={rel.id} onClick={() => onSelect?.(rel.id)} style={{ borderBottom: `1px solid ${COLORS.border}`, cursor: \"pointer\" }} className=\"hover:bg-[#F3F7FC] transition-colors\">\n                <td style={{ padding: \"14px 16px\", fontFamily: \"monospace\", fontWeight: 600, color: COLORS.navy }}>\n                  REL-{rel.id}\n                </td>\n                <td style={{ padding: \"14px 16px\", color: COLORS.navy }}>\n                  {(rel.relationshipType || \"direct\").charAt(0).toUpperCase() + (rel.relationshipType || \"direct\").slice(1)}\n                </td>\n                <td style={{ padding: \"14px 16px\", color: \"#6B7A90\" }}>{rel.tags?.[0] || \"\u2014\"}</td>\n                <td style={{ padding: \"14px 16px\", color: \"#6B7A90\" }}>\n                  {new Date(rel.createdAt).toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" })}\n                </td>\n                <td style={{ padding: \"14px 16px\" }}>\n                  <span style={{ color: isActive ? COLORS.green : \"#94A3B8\", fontWeight: 600 }}>\n                    {isActive ? \"Active\" : \"Dormant\"}\n                  </span>\n                </td>\n                <td style={{ padding: \"14px 16px\", fontWeight: 600, color: COLORS.gold }}>\n                  {formatCurrency(parseFloat(rel.totalEarnings || \"0\"))}\n                </td>\n                <td style={{ padding: \"14px 16px\" }}>\n                  <div style={{ display: \"flex\", gap: 12 }}>\n                    <button\n                      onClick={() => onCopyHash(rel.timestampHash)}\n                      style={{\n                        background: \"none\",\n                        border: \"none\",\n                        cursor: \"pointer\",\n                        color: COLORS.blue,\n                        display: \"flex\",\n                        alignItems: \"center\",\n                        gap: 4,\n                        fontSize: 13,\n                        fontWeight: 500,\n                      }}\n                    >\n                      <Copy size={14} /> Copy Hash\n                    </button>\n                    {onExportProof && (\n                      <button\n                        onClick={() => onExportProof(rel.id)}\n                        style={{\n                          background: \"none\",\n                          border: \"none\",\n                          cursor: \"pointer\",\n                          color: COLORS.blue,\n                          display: \"flex\",\n                          alignItems: \"center\",\n                          gap: 4,\n                          fontSize: 13,\n                          fontWeight: 500,\n                        }}\n                      >\n                        Export Proof\n                      </button>\n                    )}\n                  </div>\n                </td>\n              </tr>\n            );\n          })}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\n/* -------------------------------------------------------------------------\n   Relationship Detail Panel (Sheet)\n   ------------------------------------------------------------------------- */\n\nfunction RelationshipDetailPanel({ relationshipId, onClose }: { relationshipId: number; onClose: () => void }) {\n  const utils = trpc.useUtils();\n  const { data: rel, isLoading } = trpc.relationship.get.useQuery(\n    { id: relationshipId },\n    { enabled: !!relationshipId },\n  );\n\n  const { data: contacts, refetch: refetchContacts } = trpc.contact.getByRelationship.useQuery(\n    { relationshipId },\n    { enabled: !!relationshipId },\n  );\n\n  const [editNotes, setEditNotes] = useState(\"\");\n  const [editStrength, setEditStrength] = useState(\"\");\n  const [notesDirty, setNotesDirty] = useState(false);\n  const [contactForm, setContactForm] = useState({ displayName: \"\", platform: \"email\" as string, handle: \"\" });\n  const [showContactForm, setShowContactForm] = useState(false);\n\n  useEffect(() => {\n    if (rel) {\n      setEditNotes(rel.notes || \"\");\n      setEditStrength(rel.strength || \"moderate\");\n      setNotesDirty(false);\n    }\n  }, [rel]);\n\n  const updateMutation = trpc.relationship.update.useMutation({\n    onSuccess: () => {\n      toast.success(\"Relationship updated\");\n      utils.relationship.get.invalidate({ id: relationshipId });\n      utils.relationship.list.invalidate();\n    },\n    onError: (e) => toast.error(e.message),\n  });\n\n  const grantConsentMutation = trpc.relationship.grantConsent.useMutation({\n    onSuccess: () => {\n      toast.success(\"Consent granted \u2014 relationship is now fully visible\");\n      utils.relationship.get.invalidate({ id: relationshipId });\n      utils.relationship.list.invalidate();\n    },\n    onError: (e) => toast.error(e.message),\n  });\n\n  const addContactMutation = trpc.contact.add.useMutation({\n    onSuccess: () => {\n      toast.success(\"Contact added\");\n      refetchContacts();\n      setContactForm({ displayName: \"\", platform: \"email\", handle: \"\" });\n      setShowContactForm(false);\n    },\n    onError: (e) => toast.error(e.message),\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"py-12 flex items-center justify-center\">\n        <Loader2 className=\"w-6 h-6 animate-spin\" style={{ color: COLORS.blue }} />\n      </div>\n    );\n  }\n\n  if (!rel) {\n    return <p className=\"py-8 text-center text-muted-foreground text-sm\">Relationship not found</p>;\n  }\n\n  return (\n    <div className=\"space-y-6 pt-2\">\n      <SheetHeader>\n        <SheetTitle className=\"text-lg\" style={{ color: COLORS.navy }}>\n          REL-{rel.id}\n        </SheetTitle>\n        <SheetDescription>\n          {(rel.relationshipType || \"direct\").charAt(0).toUpperCase() + (rel.relationshipType || \"direct\").slice(1)} relationship\n        </SheetDescription>\n      </SheetHeader>\n\n      {/* Metadata */}\n      <section className=\"space-y-3\">\n        <DetailRow label=\"Type\" value={(rel.relationshipType || \"direct\").charAt(0).toUpperCase() + (rel.relationshipType || \"direct\").slice(1)} />\n        <DetailRow label=\"Status\" value={rel.isBlind ? \"Custodied (Blind)\" : \"Open\"} />\n        <DetailRow label=\"Custody Timestamp\" value={new Date(rel.createdAt).toLocaleString()} />\n        <DetailRow label=\"Established\" value={rel.establishedAt ? new Date(rel.establishedAt).toLocaleDateString() : \"\u2014\"} />\n        {rel.tags && rel.tags.length > 0 && (\n          <div className=\"flex items-center justify-between text-sm\">\n            <span style={{ color: \"#6B7A90\" }}>Tags</span>\n            <div className=\"flex gap-1 flex-wrap justify-end\">\n              {rel.tags.map((t: string) => (\n                <span key={t} className=\"px-2 py-0.5 rounded-full text-[11px] font-medium\" style={{ background: `${COLORS.blue}10`, color: COLORS.blue }}>\n                  {t}\n                </span>\n              ))}\n            </div>\n          </div>\n        )}\n      </section>\n\n      {/* Grant Consent */}\n      {rel.isBlind && (\n        <button\n          onClick={() => grantConsentMutation.mutate({ id: relationshipId })}\n          disabled={grantConsentMutation.isPending}\n          className=\"w-full flex items-center justify-center gap-2 h-10 rounded-lg text-sm font-semibold text-white transition-colors disabled:opacity-50\"\n          style={{ background: COLORS.green }}\n        >\n          {grantConsentMutation.isPending ? (\n            <><Loader2 className=\"w-4 h-4 animate-spin\" /> Granting...</>\n          ) : (\n            <><ShieldCheck className=\"w-4 h-4\" /> Grant Consent</>\n          )}\n        </button>\n      )}\n\n      {/* Inline Editing: Strength */}\n      <section>\n        <label className=\"block text-xs font-semibold mb-1.5\" style={{ color: COLORS.navy }}>Strength</label>\n        <select\n          value={editStrength}\n          onChange={(e) => {\n            setEditStrength(e.target.value);\n            updateMutation.mutate({\n              id: relationshipId,\n              strength: e.target.value as any,\n            });\n          }}\n          className=\"w-full h-9 px-3 rounded-lg border text-sm\"\n          style={{ borderColor: COLORS.border, color: COLORS.navy }}\n        >\n          <option value=\"weak\">Weak</option>\n          <option value=\"moderate\">Moderate</option>\n          <option value=\"strong\">Strong</option>\n          <option value=\"very_strong\">Very Strong</option>\n        </select>\n      </section>\n\n      {/* Inline Editing: Notes */}\n      <section>\n        <label className=\"block text-xs font-semibold mb-1.5\" style={{ color: COLORS.navy }}>Notes</label>\n        <textarea\n          value={editNotes}\n          onChange={(e) => { setEditNotes(e.target.value); setNotesDirty(true); }}\n          className=\"w-full rounded-lg border p-3 text-sm resize-none focus:outline-none focus:ring-2\"\n          style={{ borderColor: COLORS.border, minHeight: 80 }}\n          placeholder=\"Add notes...\"\n        />\n        {notesDirty && (\n          <button\n            onClick={() => {\n              updateMutation.mutate({ id: relationshipId, notes: editNotes });\n              setNotesDirty(false);\n            }}\n            disabled={updateMutation.isPending}\n            className=\"mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold text-white disabled:opacity-50\"\n            style={{ background: COLORS.blue }}\n          >\n            {updateMutation.isPending ? <Loader2 className=\"w-3 h-3 animate-spin\" /> : <Save className=\"w-3 h-3\" />}\n            Save Notes\n          </button>\n        )}\n      </section>\n\n      {/* Contacts */}\n      <section>\n        <div className=\"flex items-center justify-between mb-3\">\n          <h4 className=\"text-sm font-semibold\" style={{ color: COLORS.navy }}>Contacts</h4>\n          <button\n            onClick={() => setShowContactForm(!showContactForm)}\n            className=\"inline-flex items-center gap-1 text-xs font-semibold\"\n            style={{ color: COLORS.blue }}\n          >\n            <UserPlus className=\"w-3.5 h-3.5\" />\n            Add\n          </button>\n        </div>\n\n        {contacts && contacts.length > 0 ? (\n          <div className=\"space-y-2\">\n            {contacts.map((c: any) => (\n              <div key={c.id} className=\"flex items-center gap-3 p-2.5 rounded-lg\" style={{ background: COLORS.surface }}>\n                <ContactIcon platform={c.platform} />\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium truncate\" style={{ color: COLORS.navy }}>\n                    {c.displayName || c.handle}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground truncate\">\n                    {c.platform} \u00b7 {c.handle}\n                  </p>\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : (\n          <p className=\"text-xs text-muted-foreground\">No contacts linked yet.</p>\n        )}\n\n        {showContactForm && (\n          <div className=\"mt-3 p-3 rounded-lg border space-y-2.5\" style={{ borderColor: COLORS.border }}>\n            <input\n              type=\"text\"\n              placeholder=\"Display name\"\n              value={contactForm.displayName}\n              onChange={(e) => setContactForm({ ...contactForm, displayName: e.target.value })}\n              className=\"w-full h-8 px-3 rounded border text-sm\"\n              style={{ borderColor: COLORS.border }}\n            />\n            <select\n              value={contactForm.platform}\n              onChange={(e) => setContactForm({ ...contactForm, platform: e.target.value })}\n              className=\"w-full h-8 px-3 rounded border text-sm\"\n              style={{ borderColor: COLORS.border, color: COLORS.navy }}\n            >\n              <option value=\"email\">Email</option>\n              <option value=\"phone\">Phone</option>\n              <option value=\"linkedin\">LinkedIn</option>\n              <option value=\"telegram\">Telegram</option>\n              <option value=\"discord\">Discord</option>\n              <option value=\"whatsapp\">WhatsApp</option>\n              <option value=\"twitter\">Twitter</option>\n              <option value=\"other\">Other</option>\n            </select>\n            <input\n              type=\"text\"\n              placeholder=\"Handle / value\"\n              value={contactForm.handle}\n              onChange={(e) => setContactForm({ ...contactForm, handle: e.target.value })}\n              className=\"w-full h-8 px-3 rounded border text-sm\"\n              style={{ borderColor: COLORS.border }}\n            />\n            <button\n              onClick={() => {\n                if (!contactForm.handle) { toast.error(\"Handle is required\"); return; }\n                addContactMutation.mutate({\n                  platform: contactForm.platform as any,\n                  handle: contactForm.handle,\n                  displayName: contactForm.displayName || undefined,\n                });\n              }}\n              disabled={addContactMutation.isPending}\n              className=\"w-full h-8 rounded-lg text-xs font-semibold text-white disabled:opacity-50\"\n              style={{ background: COLORS.gold }}\n            >\n              {addContactMutation.isPending ? \"Adding...\" : \"Add Contact\"}\n            </button>\n          </div>\n        )}\n      </section>\n    </div>\n  );\n}\n\nfunction DetailRow({ label, value }: { label: string; value: string }) {\n  return (\n    <div className=\"flex items-center justify-between text-sm\">\n      <span style={{ color: \"#6B7A90\" }}>{label}</span>\n      <span className=\"font-medium\" style={{ color: COLORS.navy }}>{value}</span>\n    </div>\n  );\n}\n\nfunction ContactIcon({ platform }: { platform: string }) {\n  const cls = \"w-4 h-4\";\n  const style = { color: COLORS.blue };\n  switch (platform) {\n    case \"email\": return <Mail className={cls} style={style} />;\n    case \"phone\": return <Phone className={cls} style={style} />;\n    case \"linkedin\": return <Linkedin className={cls} style={style} />;\n    default: return <Users className={cls} style={style} />;\n  }\n}\n\n/* -------------------------------------------------------------------------\n   Modal Steps\n   ------------------------------------------------------------------------- */\n\nfunction ModalStepType({ selected, onSelect }: { selected: string; onSelect: (v: string) => void }) {\n  return (\n    <div>\n      <h3 style={{ fontSize: 16, fontWeight: 600, color: COLORS.navy, marginBottom: 4 }}>Relationship Type</h3>\n      <p style={{ fontSize: 13, color: \"#6B7A90\", marginBottom: 20 }}>Select the type of relationship you want to protect.</p>\n      <div style={{ display: \"grid\", gridTemplateColumns: \"1fr 1fr\", gap: 12 }}>\n        {REL_TYPES.map((t) => {\n          const Icon = t.icon;\n          const isSelected = selected === t.value;\n          return (\n            <button\n              key={t.value}\n              onClick={() => onSelect(t.value)}\n              style={{\n                padding: 16,\n                borderRadius: 10,\n                border: `2px solid ${isSelected ? COLORS.gold : COLORS.border}`,\n                background: isSelected ? `${COLORS.gold}08` : \"#fff\",\n                cursor: \"pointer\",\n                display: \"flex\",\n                alignItems: \"center\",\n                gap: 12,\n                textAlign: \"left\",\n              }}\n            >\n              <div\n                style={{\n                  width: 40,\n                  height: 40,\n                  borderRadius: 10,\n                  background: isSelected ? COLORS.gold : COLORS.surface,\n                  display: \"flex\",\n                  alignItems: \"center\",\n                  justifyContent: \"center\",\n                }}\n              >\n                <Icon size={18} style={{ color: isSelected ? \"#fff\" : \"#6B7A90\" }} />\n              </div>\n              <span style={{ fontWeight: 600, fontSize: 14, color: COLORS.navy }}>{t.label}</span>\n              {isSelected && <Check size={16} style={{ marginLeft: \"auto\", color: COLORS.gold }} />}\n            </button>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n\nfunction ModalStepProfile({\n  sectors, onSectorsChange,\n  dealMin, dealMax, onDealMinChange, onDealMaxChange,\n  regions, onRegionsChange,\n  requirements, onRequirementsChange,\n}: {\n  sectors: string[]; onSectorsChange: (v: string[]) => void;\n  dealMin: string; dealMax: string; onDealMinChange: (v: string) => void; onDealMaxChange: (v: string) => void;\n  regions: string[]; onRegionsChange: (v: string[]) => void;\n  requirements: string; onRequirementsChange: (v: string) => void;\n}) {\n  const toggleChip = (list: string[], setter: (v: string[]) => void, val: string) => {\n    setter(list.includes(val) ? list.filter((v) => v !== val) : [...list, val]);\n  };\n\n  return (\n    <div>\n      <h3 style={{ fontSize: 16, fontWeight: 600, color: COLORS.navy, marginBottom: 4 }}>Deal Profile</h3>\n      <p style={{ fontSize: 13, color: \"#6B7A90\", marginBottom: 20 }}>Define the deal profile for this relationship.</p>\n\n      <FieldLabel>Sector</FieldLabel>\n      <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: 8, marginBottom: 20 }}>\n        {SECTORS.map((s) => (\n          <ChipButton key={s} active={sectors.includes(s)} onClick={() => toggleChip(sectors, onSectorsChange, s)}>\n            {s}\n          </ChipButton>\n        ))}\n      </div>\n\n      <FieldLabel>Deal Size Range</FieldLabel>\n      <div style={{ display: \"flex\", gap: 12, marginBottom: 20 }}>\n        <input\n          type=\"text\"\n          placeholder=\"Min ($)\"\n          value={dealMin}\n          onChange={(e) => onDealMinChange(e.target.value)}\n          style={inputStyle}\n        />\n        <input\n          type=\"text\"\n          placeholder=\"Max ($)\"\n          value={dealMax}\n          onChange={(e) => onDealMaxChange(e.target.value)}\n          style={inputStyle}\n        />\n      </div>\n\n      <FieldLabel>Geographic Focus</FieldLabel>\n      <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: 8, marginBottom: 20 }}>\n        {REGIONS.map((r) => (\n          <ChipButton key={r} active={regions.includes(r)} onClick={() => toggleChip(regions, onRegionsChange, r)}>\n            {r}\n          </ChipButton>\n        ))}\n      </div>\n\n      <FieldLabel>Specific Requirements</FieldLabel>\n      <textarea\n        rows={3}\n        placeholder=\"Add any specific requirements...\"\n        value={requirements}\n        onChange={(e) => onRequirementsChange(e.target.value)}\n        style={{ ...inputStyle, height: \"auto\", resize: \"vertical\" as const, padding: 12 }}\n      />\n    </div>\n  );\n}\n\nfunction ModalStepVerification({ level, onLevelChange }: { level: string; onLevelChange: (v: string) => void }) {\n  return (\n    <div>\n      <h3 style={{ fontSize: 16, fontWeight: 600, color: COLORS.navy, marginBottom: 4 }}>Verification Level</h3>\n      <p style={{ fontSize: 13, color: \"#6B7A90\", marginBottom: 20 }}>What level of verification can you provide?</p>\n\n      <FieldLabel>What can you confirm?</FieldLabel>\n      <div style={{ position: \"relative\", marginBottom: 20 }}>\n        <select\n          value={level}\n          onChange={(e) => onLevelChange(e.target.value)}\n          style={{\n            ...inputStyle,\n            appearance: \"none\",\n            paddingRight: 36,\n            cursor: \"pointer\",\n            color: level ? COLORS.navy : \"#94A3B8\",\n          }}\n        >\n          <option value=\"\">Select verification level</option>\n          {VERIFICATION_LEVELS.map((v) => (\n            <option key={v} value={v}>{v}</option>\n          ))}\n        </select>\n        <ChevronDown\n          size={14}\n          style={{ position: \"absolute\", right: 12, top: \"50%\", transform: \"translateY(-50%)\", pointerEvents: \"none\", color: \"#94A3B8\" }}\n        />\n      </div>\n\n      <FieldLabel>Document Upload (Optional)</FieldLabel>\n      <div\n        style={{\n          border: `2px dashed ${COLORS.border}`,\n          borderRadius: 10,\n          padding: \"32px 16px\",\n          textAlign: \"center\",\n          color: \"#94A3B8\",\n          cursor: \"pointer\",\n        }}\n      >\n        <Upload size={28} style={{ margin: \"0 auto 8px\", display: \"block\" }} />\n        <div style={{ fontSize: 14, fontWeight: 500 }}>Drop files here or click to upload</div>\n        <div style={{ fontSize: 12, marginTop: 4 }}>PDF, DOC, or images up to 10MB</div>\n      </div>\n    </div>\n  );\n}\n\nfunction ModalStepCustody({\n  exposure, onExposureChange,\n  autoMatch, onAutoMatchChange,\n}: {\n  exposure: string; onExposureChange: (v: string) => void;\n  autoMatch: boolean; onAutoMatchChange: (v: boolean) => void;\n}) {\n  const exposureOptions = [\n    { value: \"full\", label: \"Full\", desc: \"Complete profile visible to matches\" },\n    { value: \"sector-only\", label: \"Sector-only\", desc: \"Only sector and deal size visible\" },\n    { value: \"hidden\", label: \"Hidden\", desc: \"No details shared until you approve\" },\n  ];\n\n  return (\n    <div>\n      <h3 style={{ fontSize: 16, fontWeight: 600, color: COLORS.navy, marginBottom: 4 }}>Custody Settings</h3>\n      <p style={{ fontSize: 13, color: \"#6B7A90\", marginBottom: 20 }}>Control how your relationship data is shared.</p>\n\n      <FieldLabel>Match Exposure</FieldLabel>\n      <div style={{ display: \"flex\", flexDirection: \"column\", gap: 10, marginBottom: 24 }}>\n        {exposureOptions.map((opt) => (\n          <label\n            key={opt.value}\n            style={{\n              display: \"flex\",\n              alignItems: \"center\",\n              gap: 12,\n              padding: \"12px 16px\",\n              borderRadius: 10,\n              border: `2px solid ${exposure === opt.value ? COLORS.gold : COLORS.border}`,\n              background: exposure === opt.value ? `${COLORS.gold}08` : \"#fff\",\n              cursor: \"pointer\",\n            }}\n          >\n            <input\n              type=\"radio\"\n              name=\"exposure\"\n              value={opt.value}\n              checked={exposure === opt.value}\n              onChange={(e) => onExposureChange(e.target.value)}\n              style={{ accentColor: COLORS.gold }}\n            />\n            <div>\n              <div style={{ fontWeight: 600, fontSize: 14, color: COLORS.navy }}>{opt.label}</div>\n              <div style={{ fontSize: 12, color: \"#6B7A90\" }}>{opt.desc}</div>\n            </div>\n          </label>\n        ))}\n      </div>\n\n      <div\n        style={{\n          display: \"flex\",\n          alignItems: \"center\",\n          justifyContent: \"space-between\",\n          padding: \"14px 16px\",\n          borderRadius: 10,\n          border: `1px solid ${COLORS.border}`,\n          marginBottom: 24,\n        }}\n      >\n        <div>\n          <div style={{ fontWeight: 600, fontSize: 14, color: COLORS.navy }}>Auto-match consent</div>\n          <div style={{ fontSize: 12, color: \"#6B7A90\" }}>Allow automatic matching with compatible deals</div>\n        </div>\n        <button\n          onClick={() => onAutoMatchChange(!autoMatch)}\n          style={{\n            width: 44,\n            height: 24,\n            borderRadius: 12,\n            border: \"none\",\n            background: autoMatch ? COLORS.green : \"#CBD5E1\",\n            cursor: \"pointer\",\n            position: \"relative\",\n            transition: \"background 0.2s\",\n          }}\n        >\n          <div\n            style={{\n              width: 18,\n              height: 18,\n              borderRadius: \"50%\",\n              background: \"#fff\",\n              position: \"absolute\",\n              top: 3,\n              left: autoMatch ? 23 : 3,\n              transition: \"left 0.2s\",\n              boxShadow: \"0 1px 3px rgba(0,0,0,0.2)\",\n            }}\n          />\n        </button>\n      </div>\n\n      <div\n        style={{\n          padding: \"14px 16px\",\n          borderRadius: 10,\n          border: `1px solid ${COLORS.border}`,\n          background: COLORS.surface,\n        }}\n      >\n        <div style={{ fontWeight: 600, fontSize: 14, color: COLORS.navy, marginBottom: 4 }}>Attribution Split</div>\n        <div style={{ fontSize: 13, color: \"#6B7A90\" }}>\n          Team attribution splitting will be available for team accounts. Contact support to upgrade.\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ModalStepConfirmation({ id, hash, onDone }: { id: string; hash: string; onDone: () => void }) {\n  const now = new Date().toLocaleString(\"en-US\", {\n    month: \"long\",\n    day: \"numeric\",\n    year: \"numeric\",\n    hour: \"numeric\",\n    minute: \"2-digit\",\n  });\n\n  return (\n    <div style={{ textAlign: \"center\", padding: \"12px 0\" }}>\n      <div\n        style={{\n          width: 64,\n          height: 64,\n          borderRadius: \"50%\",\n          background: `${COLORS.green}15`,\n          display: \"flex\",\n          alignItems: \"center\",\n          justifyContent: \"center\",\n          margin: \"0 auto 20px\",\n        }}\n      >\n        <Shield size={32} style={{ color: COLORS.green }} />\n      </div>\n\n      <h3 style={{ fontSize: 20, fontWeight: 700, color: COLORS.navy, marginBottom: 8 }}>\n        {CUSTODY_RECEIPT.title}\n      </h3>\n      <p style={{ fontSize: 14, color: \"#6B7A90\", marginBottom: 28 }}>{CUSTODY_RECEIPT.body}</p>\n\n      <div\n        className=\"card-elevated\"\n        style={{\n          padding: 20,\n          textAlign: \"left\",\n          marginBottom: 28,\n        }}\n      >\n        <ReceiptRow label=\"Timestamp\" value={now} />\n        <ReceiptRow label=\"Custody ID\" value={id} mono />\n        <ReceiptRow label=\"Custody Proof\" value={hash.slice(0, 32) + \"...\"} mono last />\n      </div>\n\n      <button\n        onClick={onDone}\n        style={{\n          height: 44,\n          padding: \"0 40px\",\n          borderRadius: 8,\n          background: COLORS.gold,\n          color: \"#fff\",\n          fontWeight: 600,\n          fontSize: 15,\n          border: \"none\",\n          cursor: \"pointer\",\n        }}\n      >\n        Done\n      </button>\n    </div>\n  );\n}\n\nfunction ReceiptRow({ label, value, mono, last }: { label: string; value: string; mono?: boolean; last?: boolean }) {\n  return (\n    <div\n      style={{\n        display: \"flex\",\n        justifyContent: \"space-between\",\n        padding: \"10px 0\",\n        borderBottom: last ? \"none\" : `1px solid ${COLORS.border}`,\n      }}\n    >\n      <span style={{ fontSize: 13, color: \"#6B7A90\" }}>{label}</span>\n      <span\n        className={mono ? \"font-data-mono text-[10px] text-[#1E3A5F]/50 font-semibold\" : \"\"}\n        style={!mono ? { fontSize: 13, fontWeight: 600, color: COLORS.navy } : undefined}\n      >\n        {value}\n      </span>\n    </div>\n  );\n}\n\n/* -------------------------------------------------------------------------\n   Shared UI Helpers\n   ------------------------------------------------------------------------- */\n\nfunction FieldLabel({ children }: { children: React.ReactNode }) {\n  return (\n    <div style={{ fontSize: 13, fontWeight: 600, color: COLORS.navy, marginBottom: 8 }}>{children}</div>\n  );\n}\n\nfunction ChipButton({ children, active, onClick }: { children: React.ReactNode; active: boolean; onClick: () => void }) {\n  return (\n    <button\n      onClick={onClick}\n      style={{\n        padding: \"6px 14px\",\n        borderRadius: 20,\n        border: `1px solid ${active ? COLORS.gold : COLORS.border}`,\n        background: active ? `${COLORS.gold}15` : \"#fff\",\n        color: active ? COLORS.gold : \"#6B7A90\",\n        fontWeight: 500,\n        fontSize: 13,\n        cursor: \"pointer\",\n      }}\n    >\n      {children}\n    </button>\n  );\n}\n\nconst inputStyle: React.CSSProperties = {\n  width: \"100%\",\n  height: 42,\n  padding: \"0 14px\",\n  borderRadius: 8,\n  border: `1px solid ${COLORS.border}`,\n  background: \"#fff\",\n  fontSize: 14,\n  outline: \"none\",\n  color: COLORS.navy,\n};\n",
  "changes_summary": [
    "Changed page heading from 'Relationships' to 'Relationship Custody' and added a subtitle: 'Timestamped introductions with cryptographic proof of custody.'",
    "Updated filter options for 'Verification Status' from 'Protected' to 'Custodied' and 'Visible' to 'Open'.",
    "Modified filtering logic in `filteredRelationships` to use 'custodied' and 'open' values.",
    "Updated status badges on `RelationshipCard` and `RelationshipDetailPanel` from 'Protected' to 'Custodied' and 'Visible' to 'Open'.",
    "Changed 'Hash' labels to 'Custody Proof' in `CustodyHashRow`, `ProofModal`, `RelationshipCard` (flipped state), and `ModalStepConfirmation`.",
    "Applied `font-data-mono` class to hash values in `CustodyHashRow`, `ProofModal`, and `ReceiptRow` (used by `ModalStepConfirmation` and `RelationshipCard` flipped state).",
    "Replaced hardcoded confirmation text in `ModalStepConfirmation` with `CUSTODY_RECEIPT.title` and `CUSTODY_RECEIPT.body`.",
    "Changed the label for one of the 4-stat cards from 'TOTAL RELATIONSHIPS' to 'CUSTODIED RELATIONSHIPS'."
  ],
  "whitepaper_terms_added": [
    "Relationship Custody",
    "Custodied",
    "Open",
    "Custody Proof",
    "Timestamped introductions with cryptographic proof of custody."
  ],
  "copy_tokens_used": [
    "CUSTODY_RECEIPT.title",
    "CUSTODY_RECEIPT.body"
  ]
}